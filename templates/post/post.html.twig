{% extends 'base.html.twig' %}

{% block title %}{{ post.title }}{% endblock %}

{% block body %}
    {% import 'comment/tree-macro.html.twig' as tree %}
<div class="post">
    <div class="title">{{ post.title }}</div>
    <div class="created">Created: {{ post.createdAt.format('d.m.Y H:i:s') }}</div>
    <div class="updated">Updated: {{ post.updatedAt.format('d.m.Y H:i:s') }}</div>
    <div class="author"><a href="{{ url('user', {id: post.author.id}) }}">{{ post.author.name }}</a></div>
    <div class="text">{{ post.text }}</div>
    {% if is_granted('edit', post) %}
    <a href="{{ url('editPost', {id: post.id}) }}">Edit</a>
    {% endif %}
    {% if is_granted('delete', post) %}
    <button id="btn-remove" data-delete-url="{{ url('deletePost', {id: post.id}) }}">Delete</button>
    {% endif %}
    <hr>
    <a href="#" class="reply-form" data-comment-id="0">Reply</a>
    <div class="comment-form">
        {{ form_start(comment_form) }}
        <input type="submit" value="submit">
        {{ form_end(comment_form) }}
    </div>
    <hr>
    {% if post.comments.count == 0 %}
    <div class="no-comments">No comments yet</div>
    {% else %}
    <div class="comments">
    {% for comment in post.rootComments %}
        <div class="comment root">
        {{ tree.comment_tree(comment)  }}
        </div>
    {% endfor %}
    </div>
    {% endif %}
</div>
{% endblock %}
{% block javascripts %}
<script type="text/javascript">
    // todo: srsly at least rewrite this 1999 shit in fetch/axios
    let deleteEntity = (url) => {
        console.log(url);
        let xhr = new XMLHttpRequest();
        xhr.open("DELETE", url, true);
        xhr.onload = function (e) {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    console.log(xhr.responseText);
                    window.location = '/posts';
                } else {
                    console.error(xhr.statusText);
                }
            }
        };
        xhr.onerror = function (e) {
            console.error(xhr.statusText);
        };
        xhr.send(null);
    };

    let removeBtn = document.getElementById('btn-remove');
    let deletePostUrl = removeBtn.attributes.getNamedItem("data-delete-url").nodeValue;

    removeBtn.onclick = () => {
        deleteEntity(deletePostUrl)
    };


</script>
{% endblock %}